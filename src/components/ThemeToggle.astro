---
import SunIcon from "./icons/Sun.astro";
import MoonIcon from "./icons/Moon.astro";

interface Props {
  class?: string;
  id?: string;
}

const { class: className, id: containerId } = Astro.props;
const uniqueId = containerId || "theme-toggle";
---

<div
  id={uniqueId}
  class={`${className} appearance-none theme-toggle-container`}
>
  <MoonIcon
    class="theme-toggle-icon size-5 hover:scale-125 transition-all"
    data-theme="dark"
  />
  <SunIcon
    class="theme-toggle-icon size-5 hover:scale-125 transition-all"
    data-theme="light"
  />
</div>

<script is:inline>
  (function () {
    const matchMedia = window.matchMedia("(prefers-color-scheme: dark)");

    const getTheme = () =>
      localStorage.getItem("theme") || (matchMedia.matches ? "dark" : "light");

    const applyTheme = () => {
      const theme = getTheme();
      const isDark = theme === "dark";

      document.documentElement.classList.toggle("dark", isDark);

      document.querySelectorAll(".theme-toggle-icon").forEach((el) => {
        const isCurrent = el.getAttribute("data-theme") === theme;
        el.style.scale = isCurrent ? "1" : "0";
        el.classList.toggle("hidden", !isCurrent);
        el.classList.toggle("visible", isCurrent);
      });
    };

    // Create a single theme toggle handler
    const handleThemeToggle = (e) => {
      e.stopPropagation();
      localStorage.setItem("theme", getTheme() === "dark" ? "light" : "dark");
      applyTheme();
    };

    const initThemeToggle = () => {
      document
        .querySelectorAll(".theme-toggle-container")
        .forEach((container) => {
          if (container.hasAttribute("data-theme-initialized")) {
            return;
          }
          // Add the listener
          container.addEventListener("click", handleThemeToggle);
          container.setAttribute("data-theme-initialized", "true");
        });
    };

    matchMedia.addEventListener("change", applyTheme);
    document.addEventListener("astro:after-swap", () => {
      applyTheme();
      initThemeToggle();
    });

    applyTheme();
    initThemeToggle();
  })();
</script>
